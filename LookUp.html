<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shared Link Lookup</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Figtree:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Your existing CSS styles remain unchanged */
        /* ... (existing CSS code) ... */
    </style>
</head>
<body>

    <div class="container">
        <h1>Shared Link Lookup</h1>
        <p>Enter the Shared Link URL to find out how to access this content.</p>

        <div class="input-group">
            <input type="text" id="inputURL" placeholder="Enter Shared Link URL here" onkeyup="handleEnter(event)" aria-label="Shared Link URL">
            <button onclick="lookupURL()">Lookup</button>
        </div>
        
        <p class="example-link">example: https://postbox.box.com/s/umgv8vxogjyx2fn80806o107fdk9aw3y</p>

        <div id="result"></div>
        <div id="loadingOverlay">
            <div class="progress-bar-container">
                <div class="progress-bar"></div>
            </div>
        </div>

        <button class="new-lookup-button" id="newLookupButton" onclick="newLookup()">New Lookup</button>

        <p class="notice">
            <strong>Notice:</strong> Share Links from Box have been disabled because they allowed public access without sign-in. Through the efforts of the Box Health project, all access is now controlled by your Box permissions and managed by the Box Folder Owner. As a result, you may no longer have access to this content. Please update your records and any associated documentation to use the secure Box URL for accessing POST content.
        </p>

    </div>

    <script>
        let lookupTable = {};

        // Function to fetch the lookup table from the JSON file
        async function fetchLookupTable() {
            const loadingDiv = document.getElementById('loadingOverlay');
            // Show the loading indicator during initial data fetch
            loadingDiv.style.display = 'flex';

            try {
                const response = await fetch('lookupTable.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                lookupTable = await response.json();
                console.log('Lookup table loaded successfully.');
            } catch (error) {
                console.error('Failed to load lookup table:', error);
                document.getElementById('result').innerHTML = "<span style='color: red;'>Failed to load lookup data. Please try again later.</span>";
            } finally {
                // Hide the loading indicator after data fetch
                loadingDiv.style.display = 'none';
            }
        }

        // Fetch the lookup table when the page loads
        window.onload = fetchLookupTable;

        function handleEnter(event) {
            if (event.key === "Enter") {
                lookupURL();
            }
        }

        function isValidURL(url) {
            const pattern = new RegExp('^(https?:\\/\\/)' + // protocol
                '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.?)+[a-z]{2,}|' + // domain name
                '((\\d{1,3}\\.){3}\\d{1,3}))' + // OR ip (v4) address
                '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*' + // port and path
                '(\\?[;&a-z\\d%_.~+=-]*)?' + // query string
                '(\\#[-a-z\\d_]*)?$', 'i'); // fragment locator
            return !!pattern.test(url);
        }

        function lookupURL() {
            let SharedLinkURL = document.getElementById('inputURL').value.trim();
            const resultDiv = document.getElementById('result');
            const newLookupButton = document.getElementById('newLookupButton');
            const loadingOverlay = document.getElementById('loadingOverlay');

            if (SharedLinkURL === "") {
                resultDiv.innerHTML = "<span style='color: red;'>Please enter a URL.</span>";
                return;
            }

            if (!isValidURL(SharedLinkURL)) {
                resultDiv.innerHTML = "<span style='color: red;'>Please enter a valid URL.</span>";
                return;
            }

            // **New Code: Remove '.app' from the domain if present**
            SharedLinkURL = SharedLinkURL.replace('//postbox.app.box.com/', '//postbox.box.com/');

            // Show the loading indicator
            loadingOverlay.style.display = 'flex';

            const data = lookupTable[SharedLinkURL];

            // Hide the loading indicator
            loadingOverlay.style.display = 'none';

            if (data) {
                resultDiv.innerHTML = `
                    <p><strong>Box URL:</strong> <a href="${data.BoxURL}" target="_blank">${data.BoxURL}</a></p>
                    <p><strong>Box Folder Owner:</strong> ${data.BoxOwner}</p>
                    <p><strong>Item Name:</strong> ${data.ItemName}</p>
                    <p><strong>Shared Item Type:</strong> ${data.SharedItemType}</p>
                    <p><strong>Created Date:</strong> ${data.CreatedDate}</p>
                    <p><strong>Path:</strong> ${data.Path}</p>
                    <p><strong>Permissions:</strong> ${data.Permissions}</p>
                `;
                newLookupButton.style.display = 'block';
            } else {
                resultDiv.innerHTML = `
                    <span style='color: red;'>No associated information found for the provided input.</span>
                    <p>Please check the URL for any typos or contact support for further assistance.</p>
                `;
                newLookupButton.style.display = 'block';
            }
        }

        function newLookup() {
            document.getElementById('inputURL').value = '';
            document.getElementById('result').innerHTML = '';
            document.getElementById('newLookupButton').style.display = 'none';
            document.getElementById('inputURL').focus();
        }

        // Optional: Test Lookup Function
        function testLookup() {
            const testURL = "https://postbox.box.com/s/umgv8vxogjyx2fn80806o107fdk9aw3y";
            const data = lookupTable[testURL];
            console.log('Test Lookup Data:', data);
            alert(data ? data.BoxURL : 'No data found');
        }
    </script>

</body>
</html>
